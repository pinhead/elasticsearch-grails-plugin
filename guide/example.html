<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>8 Example 0.0.3.2</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <ul>
        <li>
            <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                <a href="../guide/index.html" class="button">Table of contents</a>

                <div id="nav-summary-childs" style="display:none;">
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/introduction.html"><strong>1</strong><span>Introduction</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/configuration.html"><strong>2</strong><span>Configuration</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/mapping.html"><strong>3</strong><span>Mapping</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/indexing.html"><strong>4</strong><span>Indexing</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/searching.html"><strong>5</strong><span>Searching</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/admin.html"><strong>6</strong><span>Admin</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/lowLevelAPI.html"><strong>7</strong><span>Low level API</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../guide/example.html"><strong>8</strong><span>Example</span></a>
                    </div>
                    
                </div>
            </div>
        </li>
        <li class="separator selected">
            <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
        </li>
    </ul>
</div>
<div id="header">
    <div class="images clearfix">
        
        
    </div>
    <p>The revived Elasticsearch plugin for Grails.</p>
</div>


<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/lowLevelAPI.html">&lt;&lt; <strong>7</strong><span>Low level API</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                


                <div class="project">
                    <h1>8 Example - Reference Documentation</h1>

                    <p><strong>Authors:</strong> Noam Y. Tenne, Manuarii Stein, Stephane Maldini, Serge P. Nekoval</p>

                    <p><strong>Version:</strong> 0.0.3.2</p>

                    
                </div>

                
                <div id="table-of-content">
                    <h2>Table of Contents</h2>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#twitter"><strong>8.1</strong><span>Tweets</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#theDomains"><strong>8.1.1</strong><span>The domains</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#theController"><strong>8.1.2</strong><span>The controller</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#geoDistanceSearch"><strong>8.2</strong><span>Geo Distance Search</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#geoDistanceDomains"><strong>8.2.1</strong><span>Domains</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:10px"><a href="#geoDistanceService"><strong>8.2.2</strong><span>Service Methods</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#parentChildExample"><strong>8.3</strong><span>Parent/Child mapping</span></a>
                    </div>
                    
                </div>
                

                

<h1 id="example">8 Example</h1>




<h2 id="twitter">8.1 Tweets</h2>




<h2 id="theDomains">8.1.1 The domains</h2>
<div class="code"><pre>class Tweet &#123;
  <span class="java&#45;keyword">static</span> searchable = &#123;
    message boost:2.0
  &#125;<p class="paragraph"/>  <span class="java&#45;keyword">static</span> belongsTo = &#91;
          user:User
  &#93;<p class="paragraph"/>  <span class="java&#45;keyword">static</span> hasMany = &#91;
          tags:Tag
  &#93;<p class="paragraph"/>  <span class="java&#45;keyword">static</span> constraints = &#123;
    tags nullable:<span class="java&#45;keyword">true</span>, cascade:'save, update'
  &#125;<p class="paragraph"/>  <span class="java&#45;object">String</span> message = ''
  Date dateCreated = <span class="java&#45;keyword">new</span> Date()
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class User &#123;
  <span class="java&#45;keyword">static</span> searchable = &#123;
    except = 'password'
    lastname boost:20
    firstname boost:15, index:'not_analyzed'
    listOfThings index:'no'
    someThings index:'no'
    tweets component:<span class="java&#45;keyword">true</span>
  &#125;<p class="paragraph"/>  <span class="java&#45;keyword">static</span> constraints = &#123;
    tweets cascade:'all'
  &#125;
  <span class="java&#45;keyword">static</span> hasMany = &#91;
          tweets:Tweet
  &#93;
  <span class="java&#45;keyword">static</span> mappedBy = &#91;
          tweets:'user'
  &#93;<p class="paragraph"/>  <span class="java&#45;object">String</span> lastname
  <span class="java&#45;object">String</span> firstname
  <span class="java&#45;object">String</span> password
  <span class="java&#45;object">String</span> activity = 'Evildoer'
  <span class="java&#45;object">String</span> someThings = 'something'
  ArrayList&#60;<span class="java&#45;object">String</span>&#62; listOfThings = &#91;'<span class="java&#45;keyword">this</span>', 'that', 'andthis'&#93;
&#125;</pre></div><p class="paragraph"/><div class="code"><pre>class Tag &#123;
  <span class="java&#45;keyword">static</span> searchable = &#123;
    except=&#91;'boostValue'&#93;
  &#125;<p class="paragraph"/>  <span class="java&#45;object">String</span> name
  <span class="java&#45;object">Integer</span> boostValue = 1
&#125;</pre></div>



<h2 id="theController">8.1.2 The controller</h2>
<h4>A action triggering indexation</h4>
<code>ElasticSearchController</code> (<code>testCaseService</code> is just dealing with GORM instructions):
<div class="code"><pre>class ElasticSearchController &#123;
  def elasticSearchService
  def testCaseService<p class="paragraph"/>  def postTweet = &#123;
    <span class="java&#45;keyword">if</span>(!params.user?.id) &#123;
      flash.notice = <span class="java&#45;quote">"No user selected."</span>
      redirect(action: 'index')
      <span class="java&#45;keyword">return</span>
    &#125;
    User u = User.get(params.user.id)
    <span class="java&#45;keyword">if</span> (!u) &#123;
      flash.notice = <span class="java&#45;quote">"User not found"</span>
      redirect(action: 'index')
      <span class="java&#45;keyword">return</span>
    &#125;
    // Create tweet
    testCaseService.addTweet(params.tweet?.message, u, params.tags)<p class="paragraph"/>    flash.notice = <span class="java&#45;quote">"Tweet posted"</span>
    redirect(action: 'index')
  &#125;
&#125;</pre></div>
With this code (considering that there are already <code>User</code> in the database), new Tweets will be indexed automatically,
and corresponding <code>User</code> indexed documents will be updated since we have set the <code>tweets</code> association as component.<p class="paragraph"/><h4>Searching for Tweets</h4>
<div class="code"><pre>def searchForUserTweets = &#123;
    def tweets = Tweet.search(<span class="java&#45;quote">"$&#123;params.message.search&#125;"</span>).searchResults
    def tweetsMsg = 'Messages : '
    tweets.each &#123;
      tweetsMsg += <span class="java&#45;quote">"&#60;br /&#62;Tweet from $&#123;it.user?.firstname&#125; $&#123;it.user?.lastname&#125; : $&#123;it.message&#125; "</span>
      tweetsMsg += <span class="java&#45;quote">"(tags : $&#123;it.tags?.collect&#123;t &#45;&#62; t.name&#125;&#125;)"</span>
    &#125;
    flash.notice = tweetsMsg
    redirect(action: 'index')
&#125;</pre></div><p class="paragraph"/><h4>Searching for anything</h4>
<div class="code"><pre>def searchAll = &#123;
    def res = elasticSearchService.search(<span class="java&#45;quote">"$&#123;params.query&#125;"</span>).searchResults
    def resMsg = '&#60;strong&#62;Global search result(s):&#60;/strong&#62;&#60;br /&#62;'
    res.each &#123;
      <span class="java&#45;keyword">switch</span>(it)&#123;
        <span class="java&#45;keyword">case</span> Tag:
          resMsg += <span class="java&#45;quote">"&#60;strong&#62;Tag&#60;/strong&#62; $&#123;it.name&#125;&#60;br /&#62;"</span>
          <span class="java&#45;keyword">break</span>
        <span class="java&#45;keyword">case</span> Tweet:
          resMsg += <span class="java&#45;quote">"&#60;strong&#62;Tweet&#60;/strong&#62; &#34;$&#123;it.message&#125;&#34; from $&#123;it.user.firstname&#125; $&#123;it.user.lastname&#125;&#60;br /&#62;"</span>
          <span class="java&#45;keyword">break</span>
        <span class="java&#45;keyword">case</span> User:
          resMsg += <span class="java&#45;quote">"&#60;strong&#62;User&#60;/strong&#62; $&#123;it.firstname&#125; $&#123;it.lastname&#125;&#60;br /&#62;"</span>
          <span class="java&#45;keyword">break</span>
        <span class="java&#45;keyword">default</span>:
          resMsg += <span class="java&#45;quote">"&#60;strong&#62;Other&#60;/strong&#62; $&#123;it&#125;&#60;br /&#62;"</span>
          <span class="java&#45;keyword">break</span>
      &#125;<p class="paragraph"/>    &#125;
    flash.notice = resMsg
    redirect(action:'index')
 &#125;</pre></div>


<h2 id="geoDistanceSearch">8.2 Geo Distance Search</h2>
A search for buildings with a geo_distance filter, ordered by distance.



<h2 id="geoDistanceDomains">8.2.1 Domains</h2>

<div class="code"><pre>class GeoPoint &#123;<p class="paragraph"/>    <span class="java&#45;object">Double</span> lat
    <span class="java&#45;object">Double</span> lon<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        root <span class="java&#45;keyword">false</span>
    &#125;
&#125;</pre></div>
GeoPoint represents the geo coordinates for a building. The field names <code>lat</code> and <code>lon</code> are mandatory.<p class="paragraph"/><div class="code"><pre>class Building &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> name
    GeoPoint location<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        location geoPoint: <span class="java&#45;keyword">true</span>, component: <span class="java&#45;keyword">true</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>The location of the building is mapped to an ElasticSearch <a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/mapping-geo-point-type.html" target="blank">geo_point</a>.



<h2 id="geoDistanceService">8.2.2 Service Methods</h2>
Searching for all buildings sorted by distance with 5km radius around geo location (lat=41.141, lon=11.57)<p class="paragraph"/><div class="code"><pre>def searchForBuildings() &#123;
    Closure filter = &#123;
        geo_distance(
            'distance': '5km',
            'location': &#91;lat: 48.141, lon: 11.57&#93;
        )
    &#125;<p class="paragraph"/>    def sortBuilder = SortBuilders.geoDistanceSort(<span class="java&#45;quote">"location"</span>).
        point(48.141, 11.57).
        unit(DistanceUnit.KILOMETERS).
        order(SortOrder.ASC)<p class="paragraph"/>    def result = elasticSearchService.search(
        &#91;indices: Building, types: Building, sort: sortBuilder&#93;,
        <span class="java&#45;keyword">null</span> as Closure,
        filter)<p class="paragraph"/>    <span class="java&#45;keyword">return</span> &#91;results: result.searchResults, distances: result.sort&#93;
&#125;</pre></div><p class="paragraph"/>The calculated distances are not part of the search results themselves but are part of <code>result.sort</code>.
<code>sort</code> contains all search values calculated by the ElasticSearch server as a list mapped to the id of the respective domain objects<p class="paragraph"/><h4>Example</h4>
<div class="code"><pre>assert &#91;1:&#91;23, 42&#93;, 2: &#91;24, 40&#93;&#93; == result.sort</pre></div>



<h2 id="parentChildExample">8.3 Parent/Child mapping</h2>
A store with many departments
<div class="code"><pre>class Store &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> name
    <span class="java&#45;object">String</span> description = <span class="java&#45;quote">"A description of a store"</span>
    <span class="java&#45;object">String</span> owner = <span class="java&#45;quote">"Shopowner"</span><p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = <span class="java&#45;keyword">true</span><p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        name blank: <span class="java&#45;keyword">false</span>
        description nullable: <span class="java&#45;keyword">true</span>
        owner nullable: <span class="java&#45;keyword">false</span>
    &#125;
&#125;<p class="paragraph"/>class Department &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> name
    <span class="java&#45;object">Long</span> numberOfProducts
    Store store<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        numberOfProducts nullable: <span class="java&#45;keyword">true</span>
    &#125;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> searchable = &#123;
        store parent: <span class="java&#45;keyword">true</span>, component:<span class="java&#45;keyword">true</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>Search for all departments which are childs of a store with the owner "Shopowner"<p class="paragraph"/><div class="code"><pre>def result = elasticSearchService.search(
    QueryBuilders.hasParentQuery(<span class="java&#45;quote">"store"</span>, QueryBuilders.matchQuery(<span class="java&#45;quote">"owner"</span>, <span class="java&#45;quote">"Shopowner"</span>)),
    <span class="java&#45;keyword">null</span> as Closure,
    &#91;indices: Department, types: Department&#93;
)</pre></div>



                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/lowLevelAPI.html">&lt;&lt; <strong>7</strong><span>Low level API</span></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Dynamic Domain Methods</h1><div class="menu-sub">
                        
                            
                            <div class="menu-item"><a href="../ref/Dynamic%20Domain%20Methods/countHits.html">countHits</a>
                            </div>
                            
                            <div class="menu-item"><a href="../ref/Dynamic%20Domain%20Methods/index.html">index</a>
                            </div>
                            
                            <div class="menu-item"><a href="../ref/Dynamic%20Domain%20Methods/search.html">search</a>
                            </div>
                            
                            <div class="menu-item"><a href="../ref/Dynamic%20Domain%20Methods/unindex.html">unindex</a>
                            </div>
                            
                            </div>
                    </div>
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">ElasticSearchAdminService</h1><div class="menu-sub">
                        
                            
                            <div class="menu-item"><a href="../ref/ElasticSearchAdminService/deleteIndex.html">deleteIndex</a>
                            </div>
                            
                            <div class="menu-item"><a href="../ref/ElasticSearchAdminService/refresh.html">refresh</a>
                            </div>
                            
                            </div>
                    </div>
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">ElasticSearchService</h1><div class="menu-sub">
                        
                            
                            <div class="menu-item"><a href="../ref/ElasticSearchService/countHits.html">countHits</a>
                            </div>
                            
                            <div class="menu-item"><a href="../ref/ElasticSearchService/index.html">index</a>
                            </div>
                            
                            <div class="menu-item"><a href="../ref/ElasticSearchService/search.html">search</a>
                            </div>
                            
                            <div class="menu-item"><a href="../ref/ElasticSearchService/unindex.html">unindex</a>
                            </div>
                            
                            </div>
                    </div>
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
